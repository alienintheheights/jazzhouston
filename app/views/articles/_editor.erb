<%= render :partial => "common/tinymce" %>
<link rel="stylesheet" href="/common/js/jquery/css/jquery-ui.css" type="text/css" media="all" />
<script src="/common/js/jquery-ui.min.js" type="text/javascript"></script>
<script type="text/javascript">
    /**
     * On-Ready jQuery block
     */

    $(function() {
        // calendar
        $( "#content_display_date" ).datepicker({
            dateFormat: 'yy-mm-dd'
        });

        // artist search
        $( "#content_author_search" ).autocomplete({
            source: function(request, response) {
                $.ajax({
                    url:"/members/search_ext",
                    dataType: "json",
                    data: {
                        query: request.term,
                        maxRows: 15
                    },
                    success: function(data) {
                        response($.map(data.results, function(item) {
                            return {
                                label: item.first_name +' '+ item.last_name,
                                value: item.user_id
                            }
                        }))
                    }
                })
            },
            dataType: 'json',
            minLength: 3,
            select: function( event, ui ) {
                event.preventDefault();
                var message = "You selected: <b><a href='/members/profile/"+ui.item.value+"'>"+ui.item.label+"</a></b>";
                $( "#content_author_search" ).val( ui.item.label );
                $( "<div/>" ).html( message ).prependTo( "#content_author_result" );
                $( "#content_author_result" ).scrollTop( 0 );
                $( "#content_author_id" ).val( ui.item.value );
                $( "#content_author" ).val( ui.item.label );
            }
        });

        var validateSubTitle = function(title) {

            $.ajax({
                type: "GET",
                url: '/articles/search_articles_url_ext',
                data: 'query='+ title,
                contentType: "application/json; charset=utf-8",
                async: true,
                dataType: "json",
                success: function (data, msg, j) {
                    if (data.items === 0) {
                        $("#sub_title_validate").html('<span class="valid">Valid! </span>');
                        $('#submit').attr("disabled", false);
                    } else {
                        $("#sub_title_validate").html('<span class="invalid">Invalid: That sub-title already in use</span>');
                        $("#submit").html('<span class="invalid">Invalid sub-title, please fix before submitting</span>');
                        $('#submit').attr("disabled", true);
                    }
                }
            });
        };

        var origTitle = $("#content_sub_title").val();
        $( "#content_sub_title" ).focusout( function(e, f, g) {
            var title = $("#content_sub_title").val();
            if (title && title!="" && title !== origTitle) {
                validateSubTitle(title);
            }
        });


    });

    /**
     * Validation
     */
    function validate() {
        if ( !$("#content_author_id").val()) {
            alert("You must enter an author");
            return false;
        }
        if ( !$("#content_title").val()) {
            alert("You must enter a title");
            return false;
        }
        if (!$("#content_display_date").val()) {
            alert("The story needs a display date");
            return false;
        }
        return true;
    }



</script>

<div id="StageNarrow">
  <div class="inside">

    <h2>JazzHouston Story Editor</h2>
    <%= form_for  @content, :url => { :action => @target}, :html => {:multipart => true , :onsubmit => "return validate();" } do |f| %>
        <% if @mode=="Edit" %>
            <div class="hspacer"></div>
            Preview: <a href="/articles/words/<%=@content.content_id%>"><%=@content.title%></a><br/>
            <% if @content.status_id != 2 %>
               <b> Note: your article is not yet LIVE on the site. </b>
                <br/>When you're ready, change the status at the bottom of the page to "Live"
                and click "Edit". You may preview it at any time with the above link.

            <% end %>
            <input type="hidden" id="id" name="id" value="<%=@content.content_id%>" >
        <% end %>
        <table width="100%">
          <tr>
            <td class="color4">
              <%= f.text_field :title, :size=>40, :placeholder=>"Required: Story Title" %>
			  <br/>
			  <small>This is what appears on the top of the article. Keep it concise and grammatically correct. </small>
            </td>
          </tr>

          <tr>
            <td class="color2">
              <% if !@content.photo.nil? && @content.photo.exists? then %>
                  <%= image_tag @content.photo.url(:small), :align=>"left", :width=>"100" %>
              <% end %>
              <h4>Set the article photo</h4>
              <%= f.file_field :photo %>
			  <br/>
              You may instead provide the URL of a hosted image<br/>
              <%= f.text_field :image_url, :size=>25, :placeholder=>"http://" %>
              <br/>
			  <small>This photo will be displayed on the teaser and inside the article.</small>
            </td>
          </tr>

          <tr>
            <td class="color4">


              <% if @mode=="Edit" %>
                  <input type="hidden" id="content_author" name="content[author]" value="<%=@content.author%>"/>
              <% else %>
                  <input type="hidden" id="content_author" name="content[author]"/>
              <% end %>

              <%= f.hidden_field :author_id %>
              <div class="ui-widget">
                <input id="content_author_search" size="30" placeholder="Author Search"/>
                <div id="content_author_result" ><% if @content && @content.author_id  %>
                      Existing author <b><a href="/members/profile/<%= @content.author_id %>">profile link</a> </b>
                  <% end %></div>
              </div>

				<small>The author must be a registered JazzHouston user.</small>
            </td>
          </tr>
          <tr>
            <td class="color2">
              <%= f.label :display_date %>
              <%= f.text_field :display_date, :size=>10, :placeholder=>"Click to set" %>
            </td>
          </tr>
          <tr>
            <td class="color4">

			   <small>Optional: The unique URL for the story (e.g., www.jazzhouston.com/words/<b>your_title_here</b>) </small><br/>
              <%= f.text_field :sub_title, :placeholder=>"url_name_no_spaces"%>
              <div id="sub_title_validate"></div>
            </td>
          </tr>
          <tr>
            <td class="color2">
              <%= f.text_area :teaser, :cols=>50, :rows=>5, :class =>"mceNoEditor", :placeholder=>"Required: Teaser Text"%>
            </td>
          </tr>
          <tr>
            <td class="color4">
              Article Type:
              <%
                 types=[["News",1],["Opinion",3],["Jazz Columns",4],["Interviews and Concert Reviews",5],["CD Reviews",6]]
              %>
              <%= select("content", "content_type_id", types) %><br />

            </td>
          </tr>
          <tr>
            <td class="color2">
              <%= f.label :body_text %><br />
              <%= f.text_area :body_text %> (drag bottom right corner to expand editor)
            </td>
          </tr>
          <tr>
            <td class="color4">
              Auto-Format Article? <%= check_box("content","html_break_flag") %>Yes
            </td>
          </tr>
          <tr>
            <td class="color2">
              Article Status
              <%
                 status=[["Expired",0],["Working",1],["Live",2],["Archived",3]]
              %>
              <%= select("content", "status_id", status) %><br />
              "Working" means it's still in edit mode and not live on the site.
              <br/>
              "Live" means it's up and visible anywhere articles are listed on the site.
              <br/>
              "Archived" will remove it from the listing of current articles but can still be accessed by it's URL.
              <br/>
              "Expired" means it will be removed and marked for deletion.
              <br/>
            </td>
          </tr>
          <tr>
            <td class="color4">
              <%= f.submit @mode, :id=>'submit' %>
            </td>
          </tr>
        </table>
    <% end %>

  </div>
</div>
